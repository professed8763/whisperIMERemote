name: Build APK

on:
  push:
    branches: [ 'claude/**' ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install SDK components
      run: |
        sdkmanager "platforms;android-35" "build-tools;35.0.0"

    - name: Make gradlew executable
      run: chmod +x gradlew

    - name: Run unit tests
      id: test
      run: |
        ./gradlew test --stacktrace > build-output.txt 2>&1 || true
        if grep -q "BUILD SUCCESSFUL" build-output.txt; then
          echo "result=success" >> $GITHUB_OUTPUT
        else
          echo "result=failure" >> $GITHUB_OUTPUT
        fi

    - name: Post build errors to issue
      if: steps.test.outputs.result == 'failure'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const output = fs.readFileSync('build-output.txt', 'utf8');
          const last200 = output.split('\n').slice(-200).join('\n');
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'build-error',
            state: 'open'
          });
          const title = `Build Error - ${context.sha.substring(0, 7)}`;
          const body = `## Build Output (last 200 lines)\n\`\`\`\n${last200}\n\`\`\``;
          if (issues.data.length > 0) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issues.data[0].number,
              body: body
            });
          } else {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['build-error']
            });
          }

    - name: Fail if tests failed
      if: steps.test.outputs.result == 'failure'
      run: exit 1

    - name: Build Debug APK
      run: ./gradlew assembleDebug --stacktrace

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: whisper-remote-debug
        path: app/build/outputs/apk/debug/app-debug.apk
